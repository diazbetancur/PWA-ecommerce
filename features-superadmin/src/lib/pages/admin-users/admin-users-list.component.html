<div class="admin-users-container">
  <!-- ðŸ“Œ Header con tÃ­tulo y acciones -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>people</mat-icon>
        Usuarios Administrativos
      </h1>
    </div>
    <button
      mat-raised-button
      color="primary"
      (click)="openCreateDialog()"
      class="create-button"
    >
      <mat-icon>add</mat-icon>
      Nuevo Usuario
    </button>
  </div>

  <!-- ðŸ” Filtros -->
  <div class="filters-section">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Buscar por email o nombre</mat-label>
      <input
        matInput
        [(ngModel)]="searchTerm"
        (keyup.enter)="applyFilters()"
        placeholder="Buscar..."
      />
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Rol</mat-label>
      <mat-select [(ngModel)]="selectedRole">
        <mat-option value="all">Todos los roles</mat-option>
        @for (role of roleOptions; track role) {
          <mat-option [value]="role">
            {{ getRoleLabel(role) }}
          </mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Estado</mat-label>
      <mat-select [(ngModel)]="selectedStatus">
        <mat-option value="all">Todos</mat-option>
        <mat-option value="active">Activos</mat-option>
        <mat-option value="inactive">Inactivos</mat-option>
      </mat-select>
    </mat-form-field>

    <button
      mat-raised-button
      color="accent"
      (click)="applyFilters()"
      class="filter-button"
    >
      <mat-icon>filter_list</mat-icon>
      Aplicar
    </button>

    <button
      mat-button
      (click)="clearFilters()"
      class="clear-filters-button"
    >
      <mat-icon>clear</mat-icon>
      Limpiar
    </button>
  </div>

  <!-- â³ Loading -->
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando usuarios...</p>
    </div>
  }

  <!-- âŒ Error -->
  @else if (error()) {
    <div class="error-container">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h3>Error al cargar usuarios</h3>
      <p>{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="loadUsers()">
        <mat-icon>refresh</mat-icon>
        Reintentar
      </button>
    </div>
  }

  <!-- ðŸ“­ Empty State -->
  @else if (isEmpty()) {
    <div class="empty-container">
      <mat-icon class="empty-icon">people_outline</mat-icon>
      <h3>No hay usuarios</h3>
      <p>No se encontraron usuarios administrativos</p>
      <button mat-raised-button color="primary" (click)="openCreateDialog()">
        <mat-icon>add</mat-icon>
        Crear Primer Usuario
      </button>
    </div>
  }

  <!-- ðŸ“Š Tabla de usuarios -->
  @else if (hasData()) {
    <div class="table-container">
      <table mat-table [dataSource]="users()" class="users-table">
        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef>Email</th>
          <td mat-cell *matCellDef="let user">
            <div class="user-email">
              <mat-icon class="user-icon">email</mat-icon>
              <span class="email-text">{{ user.email }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Full Name Column -->
        <ng-container matColumnDef="fullName">
          <th mat-header-cell *matHeaderCellDef>Nombre Completo</th>
          <td mat-cell *matCellDef="let user">{{ user.fullName }}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let user">
            <mat-chip
              [class]="user.isActive ? 'status-active' : 'status-inactive'"
            >
              <mat-icon class="status-icon">
                {{ user.isActive ? 'check_circle' : 'cancel' }}
              </mat-icon>
              {{ user.isActive ? 'Activo' : 'Inactivo' }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Last Login Column -->
        <ng-container matColumnDef="lastLogin">
          <th mat-header-cell *matHeaderCellDef>Ãšltimo Login</th>
          <td mat-cell *matCellDef="let user">
            <div class="last-login">
              <mat-icon class="login-icon">schedule</mat-icon>
              <span>{{ formatDate(user.lastLoginAt) }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let user">
            <button
              mat-icon-button
              [matMenuTriggerFor]="menu"
              [matTooltip]="'Acciones'"
            >
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="openEditDialog(user)">
                <mat-icon>edit</mat-icon>
                <span>Editar</span>
              </button>
              <button mat-menu-item (click)="openRolesDialog(user)">
                <mat-icon>admin_panel_settings</mat-icon>
                <span>Gestionar Roles</span>
              </button>
              <button mat-menu-item (click)="toggleUserStatus(user)">
                <mat-icon>
                  {{ user.isActive ? 'block' : 'check_circle' }}
                </mat-icon>
                <span>{{ user.isActive ? 'Desactivar' : 'Activar' }}</span>
              </button>
              <mat-divider></mat-divider>
              <button
                mat-menu-item
                (click)="deleteUser(user)"
                class="delete-action"
                [disabled]="isSuperAdmin(user)"
              >
                <mat-icon>delete</mat-icon>
                <span>Eliminar</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <!-- ðŸ“„ PaginaciÃ³n -->
      <mat-paginator
        [length]="totalCount()"
        [pageSize]="pageSize()"
        [pageIndex]="currentPage()"
        [pageSizeOptions]="[10, 20, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons
      >
      </mat-paginator>
    </div>
  }
</div>
