<div class="points-adjustment-page">
  <!-- Header -->
  <div class="page-header">
    <h1>‚öôÔ∏è Ajuste de Puntos</h1>
    <p>Gesti√≥n manual de puntos de usuarios</p>
  </div>

  <div class="content-grid">
    <!-- Adjustment Form -->
    <div class="form-section">
      <h2>Realizar Ajuste</h2>

      <form (ngSubmit)="submitAdjustment()" #adjustmentForm="ngForm">
        <div class="form-group">
          <label for="userEmailSearch">Buscar cliente por correo</label>
          <div class="search-row">
            <input
              type="email"
              id="userEmailSearch"
              name="userEmailSearch"
              [(ngModel)]="userEmailSearch"
              placeholder="cliente@correo.com"
              class="form-input"
              (keyup.enter)="searchCustomerByEmail()"
            />
            <button
              type="button"
              class="btn-search"
              (click)="searchCustomerByEmail()"
              [disabled]="isSearchingUser()"
            >
              @if (isSearchingUser()) { Buscando... } @else { Buscar }
            </button>
          </div>

          @if (selectedCustomer()) {
          <div class="selected-user-card">
            <div>
              <strong
                >{{ selectedCustomer()!.firstName }}
                {{ selectedCustomer()!.lastName }}</strong
              >
              <div>{{ selectedCustomer()!.email }}</div>
              <small>ID: {{ selectedCustomer()!.id }}</small>
            </div>
            <button
              type="button"
              class="btn-clear-user"
              (click)="clearSelectedCustomer()"
            >
              Quitar
            </button>
          </div>
          } @if (customerSearchResults().length > 0) {
          <div class="search-results">
            @for (user of customerSearchResults(); track user.id) {
            <button
              type="button"
              class="search-result-item"
              (click)="selectCustomer(user)"
            >
              <div>
                <strong>{{ user.firstName }} {{ user.lastName }}</strong>
              </div>
              <div>{{ user.email }}</div>
              <small>ID: {{ user.id }}</small>
            </button>
            }
          </div>
          }

          <small class="help-text"
            >Busca por correo y selecciona un cliente para autocompletar el
            ID.</small
          >
        </div>

        <div class="form-group">
          <label for="userId">ID de Usuario *</label>
          <input
            type="text"
            id="userId"
            name="userId"
            [(ngModel)]="formData.userId"
            (ngModelChange)="onUserIdManualChange()"
            required
            placeholder="Ejemplo: user-123"
            class="form-input"
          />
          <small class="help-text">El ID √∫nico del usuario en el sistema</small>
        </div>

        <div class="form-group">
          <label for="points">Cantidad de Puntos *</label>
          <input
            type="number"
            id="points"
            name="points"
            [(ngModel)]="formData.points"
            required
            min="-100000"
            max="100000"
            placeholder="100 para agregar, -100 para deducir"
            class="form-input"
          />
          <small class="help-text">
            N√∫mero positivo para agregar, negativo para deducir
          </small>
        </div>

        <div class="form-group">
          <label for="reason">Raz√≥n del Ajuste *</label>
          <textarea
            id="reason"
            name="reason"
            [(ngModel)]="formData.reason"
            required
            minlength="5"
            maxlength="500"
            rows="3"
            placeholder="Explica el motivo del ajuste..."
            class="form-textarea"
          ></textarea>
          <small class="help-text"
            >Esta raz√≥n quedar√° registrada en el historial</small
          >
        </div>

        <div class="form-group">
          <label for="referenceId">Referencia (Opcional)</label>
          <input
            type="text"
            id="referenceId"
            name="referenceId"
            [(ngModel)]="formData.referenceId"
            placeholder="Ejemplo: ORDER-456, TICKET-789"
            class="form-input"
          />
          <small class="help-text"
            >ID de orden, ticket o cualquier referencia relacionada</small
          >
        </div>

        <!-- Preview -->
        @if (formData.points !== 0) {
        <div class="adjustment-preview">
          <div class="preview-header">Vista Previa</div>
          <div class="preview-content">
            @if (formData.points > 0) {
            <div class="preview-action positive">
              <span class="icon">‚¨ÜÔ∏è</span>
              <span
                >Agregar <strong>{{ formData.points }}</strong> puntos</span
              >
            </div>
            } @else {
            <div class="preview-action negative">
              <span class="icon">‚¨áÔ∏è</span>
              <span
                >Deducir
                <strong>{{ Math.abs(formData.points) }}</strong>
                puntos</span
              >
            </div>
            }
          </div>
        </div>
        }

        <!-- Submit Button -->
        <div class="form-actions">
          <button
            type="submit"
            class="btn-primary"
            [disabled]="!adjustmentForm.form.valid || isSubmitting()"
          >
            @if (isSubmitting()) {
            <span class="spinner-sm"></span>
            Procesando... } @else { ‚úì Confirmar Ajuste }
          </button>
          <button
            type="button"
            class="btn-secondary"
            (click)="resetForm()"
            [disabled]="isSubmitting()"
          >
            Limpiar
          </button>
        </div>
      </form>

      <!-- Success Message -->
      @if (successMessage()) {
      <div class="alert alert-success">
        <strong>¬°√âxito!</strong> {{ successMessage() }}
      </div>
      }

      <!-- Error Message -->
      @if (errorMessage()) {
      <div class="alert alert-danger">
        <strong>Error:</strong> {{ errorMessage() }}
      </div>
      }
    </div>

    <!-- Info & Guidelines -->
    <div class="info-section">
      <h2>Gu√≠as de Uso</h2>

      <div class="info-card">
        <h3>‚ö†Ô∏è Consideraciones Importantes</h3>
        <ul>
          <li>
            Los ajustes manuales quedan registrados en el historial del usuario
          </li>
          <li>Siempre proporciona una raz√≥n clara y detallada</li>
          <li>
            No se puede deshacer un ajuste, solo se puede hacer un nuevo ajuste
            contrario
          </li>
          <li>
            Los usuarios ver√°n este movimiento en su historial de transacciones
          </li>
        </ul>
      </div>

      <div class="info-card">
        <h3>üìã Casos de Uso Comunes</h3>
        <ul>
          <li>
            <strong>Compensaci√≥n:</strong> Agregar puntos por inconvenientes o
            errores del sistema
          </li>
          <li>
            <strong>Correcci√≥n:</strong> Ajustar puntos otorgados
            incorrectamente
          </li>
          <li>
            <strong>Promoci√≥n especial:</strong> Bonificaci√≥n por eventos o
            campa√±as
          </li>
          <li>
            <strong>Reembolso:</strong> Devolver puntos por canjes problem√°ticos
          </li>
        </ul>
      </div>

      <div class="info-card">
        <h3>üí° Mejores Pr√°cticas</h3>
        <ul>
          <li>Verifica el ID del usuario antes de confirmar</li>
          <li>Revisa el balance actual antes del ajuste</li>
          <li>
            Usa referencias cuando est√©n disponibles (ORDER-XXX, TICKET-XXX)
          </li>
          <li>S√© espec√≠fico en la raz√≥n del ajuste</li>
          <li>Documenta ajustes grandes en tu sistema de tickets</li>
        </ul>
      </div>

      <!-- Recent Adjustments -->
      <div class="recent-adjustments">
        <h3>üïí Ajustes Recientes</h3>
        <div class="adjustments-list">
          @for (adj of mockRecentAdjustments; track adj.id) {
          <div class="adjustment-item">
            <div class="adjustment-points" [class.positive]="adj.points > 0">
              {{ adj.points > 0 ? '+' : '' }}{{ adj.points }}
            </div>
            <div class="adjustment-details">
              <div class="user-id">Usuario: {{ adj.userId }}</div>
              <div class="reason">{{ adj.reason }}</div>
              <div class="time">{{ adj.time }}</div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
