<div class="product-form-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <div class="header-content">
          <app-button
            variant="ghost"
            icon="arrow_back"
            size="sm"
            (clicked)="cancel()"
          >
          </app-button>
          <h1>{{ pageTitle() }}</h1>
        </div>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Cargando...</p>
      </div>
      } @else {
      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="product-form">
        <!-- Información básica -->
        <div class="form-section">
          <h2>Información Básica</h2>

          <mat-form-field appearance="outline">
            <mat-label>Nombre del Producto *</mat-label>
            <input matInput formControlName="name" />
            @if (form.get('name')?.invalid && form.get('name')?.touched) {
            <mat-error>{{ getErrorMessage('name') }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>SKU</mat-label>
            <input matInput formControlName="sku" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Marca</mat-label>
            <input matInput formControlName="brand" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción Corta</mat-label>
            <textarea
              matInput
              formControlName="shortDescription"
              rows="2"
              maxlength="250"
            ></textarea>
            <mat-hint align="end"
              >{{ form.get('shortDescription')?.value?.length || 0 }} /
              250</mat-hint
            >
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción Completa</mat-label>
            <textarea
              matInput
              formControlName="description"
              rows="4"
            ></textarea>
          </mat-form-field>
        </div>

        <!-- Precios e Inventario -->
        <div class="form-section">
          <h2>Precios e Inventario</h2>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Precio *</mat-label>
              <input matInput type="number" formControlName="price" min="0" />
              <span matPrefix>$&nbsp;</span>
              @if (form.get('price')?.invalid && form.get('price')?.touched) {
              <mat-error>{{ getErrorMessage('price') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Precio de Comparación</mat-label>
              <input
                matInput
                type="number"
                formControlName="compareAtPrice"
                min="0"
              />
              <span matPrefix>$&nbsp;</span>
              <mat-hint>Precio antes del descuento (opcional)</mat-hint>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Stock *</mat-label>
              <input matInput type="number" formControlName="stock" min="0" />
              @if (form.get('stock')?.invalid && form.get('stock')?.touched) {
              <mat-error>{{ getErrorMessage('stock') }}</mat-error>
              }
            </mat-form-field>

            <div class="checkbox-wrapper">
              <mat-checkbox formControlName="trackInventory">
                Rastrear inventario
              </mat-checkbox>
            </div>
          </div>

          <!-- Distribución de Stock por Sucursales -->
          <div class="stock-distribution-section">
            <div class="distribution-header">
              <button
                type="button"
                class="toggle-distribution-btn"
                (click)="toggleStockDistribution()"
              >
                <i class="bi bi-box-seam"></i>
                <span>{{
                  showStockDistribution()
                    ? 'Ocultar'
                    : 'Distribuir Stock entre Sucursales'
                }}</span>
                <i
                  class="bi"
                  [class.bi-chevron-up]="showStockDistribution()"
                  [class.bi-chevron-down]="!showStockDistribution()"
                ></i>
              </button>

              @if (storeStockDistribution().length > 0) {
              <div
                class="stock-summary"
                [class.stock-invalid]="!stockDistributionValid()"
              >
                <span class="summary-label">Distribuido:</span>
                <strong>{{ totalDistributedStock() }}</strong>
                <span class="separator">/</span>
                <span>{{ totalStock() }}</span>
                <span class="remaining" [class.negative]="remainingStock() < 0">
                  ({{ remainingStock() >= 0 ? 'Disponible' : 'Excede' }}:
                  {{ Math.abs(remainingStock()) }})
                </span>
              </div>
              }
            </div>

            @if (showStockDistribution()) {
            <div class="distribution-content">
              <!-- Selector de Sucursal -->
              @if (availableStoresForSelection.length > 0) {
              <div class="add-stock-form">
                <div class="form-row-inline">
                  <select
                    class="store-select"
                    [value]="selectedStoreId() || ''"
                    (change)="onStoreSelected($any($event.target).value)"
                  >
                    <option value="">Seleccionar sucursal...</option>
                    @for (store of availableStoresForSelection; track store.id)
                    {
                    <option [value]="store.id">{{ store.name }}</option>
                    }
                  </select>

                  <input
                    type="number"
                    class="stock-input"
                    placeholder="Cantidad"
                    min="0"
                    [value]="stockAmount()"
                    (input)="stockAmount.set(+$any($event.target).value)"
                  />

                  <button
                    type="button"
                    class="btn-add-stock"
                    (click)="addStoreStock()"
                    [disabled]="!selectedStoreId() || stockAmount() <= 0"
                  >
                    <i class="bi bi-plus-circle"></i>
                    Asignar
                  </button>
                </div>

                @if (!canDistributeMore() && stockDistributionValid()) {
                <div class="alert-info-small">
                  <i class="bi bi-info-circle"></i>
                  Todo el stock ha sido distribuido
                </div>
                }
              </div>
              } @else if (storeStockDistribution().length > 0) {
              <div class="alert-info-small">
                <i class="bi bi-check-circle"></i>
                Todas las sucursales disponibles ya tienen stock asignado
              </div>
              }

              <!-- Tabla de Distribución -->
              @if (storeStockDistribution().length > 0) {
              <div class="distribution-table">
                <table>
                  <thead>
                    <tr>
                      <th>Sucursal</th>
                      <th>Stock Asignado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (item of storeStockDistribution(); track item.storeId)
                    {
                    <tr>
                      <td class="store-name">
                        <i class="bi bi-shop"></i>
                        {{ getStoreName(item.storeId) }}
                      </td>
                      <td>
                        <input
                          type="number"
                          class="stock-input-inline"
                          min="0"
                          [value]="item.stock"
                          (input)="
                            updateStoreStock(
                              item.storeId,
                              +$any($event.target).value
                            )
                          "
                        />
                      </td>
                      <td>
                        <button
                          type="button"
                          class="btn-remove"
                          (click)="removeStoreStock(item.storeId)"
                          title="Eliminar"
                        >
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                    }
                  </tbody>
                </table>
              </div>

              @if (!stockDistributionValid()) {
              <div class="alert-error">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>Error:</strong> La suma del stock distribuido ({{
                  totalDistributedStock()
                }}) excede el stock total ({{ totalStock() }})
              </div>
              } } @else {
              <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>No hay stock distribuido aún</p>
                <small>Selecciona una sucursal y asigna una cantidad</small>
              </div>
              }
            </div>
            }
          </div>
        </div>

        <!-- Imagen y Categorización -->
        <div class="form-section">
          <h2>Imagen y Categorización</h2>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>URL de Imagen Principal</mat-label>
            <input matInput formControlName="mainImageUrl" />
          </mat-form-field>

          <!-- Selector de Categorías -->
          <div class="category-selector-wrapper">
            <label class="category-label">Categorías</label>

            @if (selectedCategories().length > 0) {
            <div class="selected-categories">
              @for (category of selectedCategories(); track category.id) {
              <div class="category-chip">
                <span class="category-name">{{ category.name }}</span>
                <button
                  type="button"
                  class="remove-category"
                  (click)="removeCategory(category.id)"
                  aria-label="Eliminar categoría"
                >
                  ×
                </button>
              </div>
              }
            </div>
            }

            <app-button
              type="button"
              variant="secondary"
              icon="category"
              (clicked)="openCategorySelector()"
              class="select-category-btn"
            >
              {{
                selectedCategories().length > 0
                  ? 'Agregar Categoría'
                  : 'Seleccionar Categorías'
              }}
            </app-button>

            @if (selectedCategories().length > 0) {
            <app-button
              type="button"
              variant="ghost"
              (clicked)="clearCategories()"
              class="clear-categories-btn"
            >
              Limpiar todas
            </app-button>
            }
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Etiquetas</mat-label>
            <input
              matInput
              formControlName="tags"
              placeholder="etiqueta1, etiqueta2, etiqueta3"
            />
            <mat-hint>Separadas por comas</mat-hint>
          </mat-form-field>
        </div>

        <!-- SEO -->
        <div class="form-section">
          <h2>SEO</h2>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Meta Título</mat-label>
            <input matInput formControlName="metaTitle" maxlength="200" />
            <mat-hint align="end"
              >{{ form.get('metaTitle')?.value?.length || 0 }} / 200</mat-hint
            >
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Meta Descripción</mat-label>
            <textarea
              matInput
              formControlName="metaDescription"
              rows="2"
              maxlength="500"
            ></textarea>
            <mat-hint align="end"
              >{{ form.get('metaDescription')?.value?.length || 0 }} /
              500</mat-hint
            >
          </mat-form-field>
        </div>

        <!-- Opciones -->
        <div class="form-section">
          <h2>Opciones</h2>

          <div class="checkboxes-group">
            <mat-checkbox formControlName="isActive">
              Producto activo
            </mat-checkbox>

            <mat-checkbox formControlName="isFeatured">
              Producto destacado
            </mat-checkbox>
          </div>
        </div>

        <!-- Acciones -->
        <div class="form-actions">
          <app-button
            type="button"
            variant="ghost"
            icon="close"
            (clicked)="cancel()"
            [disabled]="loading()"
          >
            Cancelar
          </app-button>

          <app-button
            type="submit"
            variant="primary"
            icon="save"
            [disabled]="loading() || form.invalid"
            [loading]="loading()"
          >
            {{ submitButtonText() }}
          </app-button>
        </div>
      </form>
      }
    </mat-card-content>
  </mat-card>
</div>
