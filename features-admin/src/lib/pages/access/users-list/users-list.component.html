<div class="users-container">
  <!-- Toolbar -->
  <div class="users-toolbar">
    <div class="toolbar-left">
      <h1 class="toolbar-title">
        <mat-icon>people</mat-icon>
        {{ title() }}
      </h1>
      <p class="toolbar-subtitle">
        {{ subtitle() }}
      </p>
    </div>
    <div class="toolbar-actions">
      <button
        mat-raised-button
        color="primary"
        (click)="openCreateDialog()"
        [disabled]="isLoading()"
      >
        <mat-icon>person_add</mat-icon>
        {{ createLabel() }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>{{ loadingLabel() }}</p>
  </div>
  }

  <!-- Error State -->
  @if (isError() && !isLoading()) {
  <div class="error-container">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <h3>{{ errorTitle() }}</h3>
    <p>{{ errorMessage() }}</p>
    <button mat-raised-button color="primary" (click)="loadUsers()">
      <mat-icon>refresh</mat-icon>
      Reintentar
    </button>
  </div>
  }

  <!-- Empty State -->
  @if (!isLoading() && !isError() && users().length === 0) {
  <div class="empty-container">
    <mat-icon class="empty-icon">person_add</mat-icon>
    <h3>{{ emptyTitle() }}</h3>
    <p>{{ emptyDescription() }}</p>
    <button mat-raised-button color="primary" (click)="openCreateDialog()">
      <mat-icon>add</mat-icon>
      {{ createLabel() }}
    </button>
  </div>
  }

  <!-- Data Table -->
  @if (!isLoading() && !isError() && users().length > 0) {
  <div class="table-container">
    <table mat-table [dataSource]="users()" class="users-table">
      <!-- Nombre Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nombre</th>
        <td mat-cell *matCellDef="let user">
          <div class="user-name">
            <strong>{{ user.firstName }} {{ user.lastName }}</strong>
          </div>
        </td>
      </ng-container>

      <!-- Email Column -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef>Email</th>
        <td mat-cell *matCellDef="let user">
          <span class="user-email">{{ user.email }}</span>
        </td>
      </ng-container>

      <!-- Roles Column -->
      <ng-container matColumnDef="roles">
        <th mat-header-cell *matHeaderCellDef>Roles</th>
        <td mat-cell *matCellDef="let user">
          <div class="roles-container">
            @for (role of user.roles; track role) {
            <mat-chip [class]="'chip-' + getRoleBadgeColor(role)">{{
              role
            }}</mat-chip>
            } @if (user.roles.length === 0) {
            <span class="no-roles">Sin roles</span>
            }
          </div>
        </td>
      </ng-container>

      <!-- Estado Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let user">
          @if (user.isActive) {
          <mat-chip class="chip-active">Activo</mat-chip>
          } @else {
          <mat-chip class="chip-inactive">Inactivo</mat-chip>
          }
        </td>
      </ng-container>

      <!-- Último Login Column -->
      <ng-container matColumnDef="lastLogin">
        <th mat-header-cell *matHeaderCellDef>Último acceso</th>
        <td mat-cell *matCellDef="let user">
          <span class="last-login">{{ formatLastLogin(user.lastLoginAt) }}</span>
        </td>
      </ng-container>

      <!-- Acciones Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let user" class="actions-cell">
          <button
            mat-icon-button
            [matTooltip]="'Editar usuario'"
            (click)="openEditDialog(user)"
          >
            <mat-icon>edit</mat-icon>
          </button>

          <button
            mat-icon-button
            [matTooltip]="'Asignar roles'"
            (click)="navigateToRoles(user)"
          >
            <mat-icon>admin_panel_settings</mat-icon>
          </button>

          <button
            mat-icon-button
            [matTooltip]="user.isActive ? 'Desactivar' : 'Activar'"
            (click)="toggleUserStatus(user)"
          >
            <mat-icon>{{ user.isActive ? 'person_off' : 'person' }}</mat-icon>
          </button>

          <button
            mat-icon-button
            [matTooltip]="'Eliminar usuario'"
            (click)="deleteUser(user)"
            class="delete-btn"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>
  }
</div>
